# سيناريو كامل لنظام إدارة شركات المولدات

## 1️⃣ إنشاء الشركة

- **الفاعل:** SUPER_ADMIN
- **الإجراءات:**
  1. SUPER_ADMIN يدخل لوحة التحكم.
  2. يختار "إنشاء شركة جديدة".
  3. يملأ بيانات الشركة:
     - `name`
     - `ownerName`
     - `phone`
     - `email`
  4. يحدد **الباقة (Plan)**:
     - تحدد عدد المشتركين المسموح به
     - السعر الشهري
     - المميزات
  5. يحدد **تاريخ بداية ونهاية الاشتراك** (`subscriptionStart`, `subscriptionEnd`).
  6. الشركة تُنشأ مع حالة `status = ACTIVE`.

- **الموديلات المستخدمة:** `Company`, `Plan`

---

## 2️⃣ إنشاء المستخدمين للشركة

- **الفاعل:** SUPER_ADMIN
- **الإجراءات:**
  1. إنشاء **Company Admin** للشركة:
     - `fullName`, `email`, `password`
     - `role = COMPANY_ADMIN`
  2. إنشاء مستخدمين آخرين لاحقًا: `ACCOUNTANT`, `COLLECTOR`

- **الموديلات المستخدمة:** `User`

---

## 3️⃣ إنشاء المناطق والعدادات

- **الفاعل:** COMPANY_ADMIN
- **الإجراءات:**
  1. إضافة المناطق (Area) التي تغطيها الشركة:
     - `primaryArea` و `secondaryArea`
  2. إنشاء عداد (Meter) لكل مشترك أو لكل منطقة

- **الموديلات المستخدمة:** `Area`, `Meter`

---

## 4️⃣ إنشاء المشتركين (Subscriber)

- **الفاعل:** COMPANY_ADMIN أو COLLECTOR
- **الإجراءات:**
  1. إضافة مشترك جديد:
     - `fullName`, `phone`, `nationalId`, `address`
  2. تحديد **المنطقة** (`primaryArea`, `secondaryArea`)
  3. ربط **المحصل المسؤول** (`assignedCollector`)
  4. ربط **العداد** (`meterId`) مع `initialReading`
  5. التحقق من **حد الباقة** باستخدام Middleware

- **الموديلات المستخدمة:** `Subscriber`, `Company`, `User`

---

## 5️⃣ جمع قراءات العداد (Reading)

- **الفاعل:** COLLECTOR (Web Mobile)
- **الإجراءات:**
  1. تصوير العداد → تحويل الصورة إلى قراءة رقمية (OCR)
  2. إذا Offline → تخزين محليًا
  3. عند توفر الإنترنت → Sync تلقائي للقراءات إلى النظام

- **الموديلات المستخدمة:** `Reading`, `Meter`, `Subscriber`, `User`

---

## 6️⃣ إنشاء الفواتير تلقائيًا (Invoice)

- **الفاعل:** النظام
- **الإجراءات:**
  1. عند وصول القراءات → إنشاء فاتورة لكل مشترك
  2. حساب **الاستهلاك** = `currentReading - previousReading`
  3. حساب **totalAmount** = `consumption × unitPrice`
  4. تهيئة:
     - `paidAmount = 0`
     - `remainingAmount = totalAmount`
     - `status = UNPAID`

- **الموديلات المستخدمة:** `Invoice`, `Reading`, `Subscriber`

---

## 7️⃣ تحصيل الدفع (Payment)

- **الفاعل:** المشترك + COLLECTOR + COMPANY_ADMIN / ACCOUNTANT
- **الإجراءات:**
  1. المشترك يدفع → نقدًا أو تحويل بنكي
  2. إذا التحويل البنكي → يمكن رفع **PaymentProof** (اختياري)
  3. COLLECTOR أو COMPANY_ADMIN يتحقق من الدفع
  4. النظام يحدث:
     - `paidAmount += المبلغ المدفوع`
     - `remainingAmount = totalAmount - paidAmount`
     - `status` → `PARTIAL` أو `PAID`
  5. تسجيل **Transaction** تلقائيًا → تحديث **صندوق المحصل**

- **الموديلات المستخدمة:** `Invoice`, `Transaction`, `Fund`, `User`

---

## 8️⃣ إدارة الصناديق (Fund)

- **الإجراءات:**
  1. لكل COLLECTOR → صندوق تلقائي
  2. كل عملية دفع → تسجل في صندوق المحصل المرتبط
  3. نقل الأموال بين الصناديق → فقط COMPANY_ADMIN / ACCOUNTANT
  4. أي حركة مالية → immutable → سجل كامل للتدقيق

- **الموديلات المستخدمة:** `Fund`, `Transaction`, `User`

---

## 9️⃣ مراجعة الحسابات والدفعات

- **الفاعل:** COMPANY_ADMIN / ACCOUNTANT
- **الإجراءات:**
  1. عرض **كل الفواتير** → مدفوعة / جزئية / غير مدفوعة
  2. عرض **رصيد الصناديق**
  3. تصحيح الأخطاء أو إضافة دفعات إضافية بنفس الفاتورة

- **الموديلات المستخدمة:** `Invoice`, `Fund`, `Transaction`

---

## ✅ خلاصة

- النظام يغطي كامل دورة حياة المشترك:
  - من إنشاء الشركة
  - إنشاء المستخدمين
  - إنشاء المشتركين والعدادات
  - جمع القراءات
  - إنشاء الفواتير تلقائيًا
  - إدارة المدفوعات وربطها بالصناديق
- الدفع الجزئي أو الكامل متاح، مع تحديث تلقائي لحالة الفاتورة
- كل حركة مالية مسجلة في Transaction ولا يمكن تعديلها لاحقًا

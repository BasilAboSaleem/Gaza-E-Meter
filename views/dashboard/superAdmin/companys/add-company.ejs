<!doctype html>
<html lang="en" dir="rtl">
<%- include('../../../partials/head.ejs') %>

  <body>
    <!-- loader -->
    <div id="loading">
      <div class="loader simple-loader">
        <div class="loader-body"></div>
      </div>
    </div>

    <%- include('../../../partials/sidebar.ejs') %>

      <main class="main-content">
        <div class="position-relative iq-banner">
          <%- include('../../../partials/navbar.ejs') %>
        </div>

        <div class="container-fluid content-inner mt-n5 py-0">
          <div class="row">
            <div class="col-lg-10 mx-auto">
              <div class="card">
                <div class="card-header">
                  <h4 class="card-title mb-0">إضافة شركة جديدة</h4>
                  <p class="text-muted mt-1">إدخال بيانات الشركة ومديرها</p>
                </div>

                <div class="card-body">
                  <form id="form-wizard1" class="mt-3 text-center">

                    <!-- Wizard Steps -->
                    <ul id="top-tab-list" class="p-0 row list-inline">
                      <li class="mb-2 col-lg-4 col-md-6 text-start active" id="company">
                        <a href="javascript:void();">
                          <div class="iq-icon me-3">
                            <svg class="svg-icon icon-20" xmlns="http://www.w3.org/2000/svg" width="20" fill="none"
                              viewBox="0 0 24 24" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z" />
                            </svg>
                          </div>
                          <span class="dark-wizard">بيانات الشركة</span>
                        </a>
                      </li>
                      <li id="admin" class="mb-2 col-lg-4 col-md-6 text-start">
                        <a href="javascript:void();">
                          <div class="iq-icon me-3">
                            <svg class="svg-icon icon-20" xmlns="http://www.w3.org/2000/svg" width="20" fill="none"
                              viewBox="0 0 24 24" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                            </svg>
                          </div>
                          <span class="dark-wizard">مدير الشركة</span>
                        </a>
                      </li>
                      <li id="confirm" class="mb-2 col-lg-4 col-md-6 text-start">
                        <a href="javascript:void();">
                          <div class="iq-icon me-3">
                            <svg class="svg-icon icon-20" xmlns="http://www.w3.org/2000/svg" width="20" fill="none"
                              viewBox="0 0 24 24" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M5 13l4 4L19 7" />
                            </svg>
                          </div>
                          <span class="dark-wizard">Finish</span>
                        </a>
                      </li>
                    </ul>

                    <!-- STEP 1: بيانات الشركة -->
                    <fieldset class="active">
                      <div class="form-card text-start">
                        <div class="row">
                          <div class="col-7">
                            <h3 class="mb-4">بيانات الشركة</h3>
                          </div>
                          <div class="col-5">
                          </div>
                        </div>
                        <div class="row">
                          <div class="col-md-6 mb-3">
                            <label class="form-label">اسم الشركة *</label>
                            <input type="text" id="companyName" class="form-control" required>
                          </div>
                          <div class="col-md-6 mb-3">
                            <label class="form-label">اسم المالك *</label>
                            <input type="text" id="ownerName" class="form-control" required>
                          </div>
                          <div class="col-md-6 mb-3">
                            <label class="form-label">هاتف الشركة</label>
                            <input type="text" id="companyPhone" class="form-control">
                          </div>

                          <div class="col-md-6 mb-3">
                            <label class="form-label">الباقة *</label>
                            <select id="plan" class="form-select" required>
                              <% plans.forEach(p=> { %>
                                <option value="<%= p._id %>">
                                  <%= p.name %>
                                </option>
                                <% }) %>
                            </select>
                          </div>
                          <div class="col-md-6 mb-3">
                            <label class="form-label">نوع الاشتراك *</label>
                            <select id="subscriptionType" class="form-select" required>
                              <option value="monthly">شهري</option>
                              <option value="3month">3 أشهر</option>
                              <option value="6month">6 أشهر</option>
                              <option value="yearly">سنوي</option>
                              <option value="permanent">دائم</option>
                            </select>
                          </div>

                        </div>
                      </div>
                      <button type="button" class="btn btn-primary next action-button float-end">التالي</button>
                    </fieldset>

                    <!-- STEP 2: بيانات مدير الشركة -->
                    <fieldset>
                      <div class="form-card text-start">
                        <div class="row">
                          <div class="col-7">
                            <h3 class="mb-4">بيانات مدير الشركة</h3>
                          </div>
                          <div class="col-5">
                          </div>
                        </div>
                        <div class="row">
                          <div class="col-md-6 mb-3">
                            <label class="form-label">الاسم الكامل *</label>
                            <input type="text" id="adminName" class="form-control" required>
                          </div>
                          <div class="col-md-6 mb-3">
                            <label class="form-label">البريد الإلكتروني *</label>
                            <input type="email" id="adminEmail" class="form-control" required>
                          </div>
                          <div class="col-md-6 mb-3">
                            <label class="form-label">الهاتف</label>
                            <input type="text" id="adminPhone" class="form-control">
                          </div>
                          <div class="col-md-6 mb-3">
                            <label class="form-label">كلمة المرور *</label>
                            <input type="password" id="adminPassword" class="form-control" required>
                          </div>
                        </div>
                      </div>
                      <button type="button" class="btn btn-primary next action-button float-end">التالي</button>
                      <button type="button"
                        class="btn btn-dark previous action-button-previous float-end me-1">السابق</button>
                    </fieldset>

                    <!-- STEP 3: تأكيد -->
                    <fieldset>
                      <div class="form-card text-center">
                        <div class="row">
                          <div class="col-7">
                            <h3 class="mb-4">تأكيد البيانات</h3>
                          </div>
                          <div class="col-5">
                          </div>
                        </div>
                        <p class="text-muted mb-4">سيتم إنشاء الشركة ومديرها مباشرة</p>
                        <button type="submit" class="btn btn-success px-5">حفظ الشركة</button>
                      </div>
                      <button type="button"
                        class="btn btn-dark previous action-button-previous float-end mt-3">السابق</button>
                    </fieldset>

                  </form>
                </div>

              </div>
            </div>
          </div>
        </div>

        <%- include('../../../partials/footer.ejs') %>
      </main>

      <%- include('../../../partials/offcanvas.ejs') %>

        <%- include('../../../partials/offcanvas.ejs') %>
          <%- include('../../../partials/scripts.ejs') %>

            <!-- Wizard CSS + Logic -->


            <script>
              const form = document.getElementById('form-wizard1');
              const fieldsets = document.querySelectorAll('fieldset');
              const steps = document.querySelectorAll('#top-tab-list li');
              let currentStep = 0;

              function showStep(index) {
                // إظهار الـ fieldset الحالي
                fieldsets.forEach((fs, i) => {
                  fs.classList.toggle('active', i === index);
                });

                // تفعيل الخطوة الحالية
                steps.forEach((step, i) => {
                  step.classList.toggle('active', i === index);
                });

                currentStep = index;
              }

              // أزرار التالي
              document.querySelectorAll('.next').forEach(btn => {
                btn.addEventListener('click', () => {
                  if (currentStep < fieldsets.length - 1) showStep(currentStep + 1);
                });
              });

              // أزرار السابق
              document.querySelectorAll('.previous').forEach(btn => {
                btn.addEventListener('click', () => {
                  if (currentStep > 0) showStep(currentStep - 1);
                });
              });

              // تفعيل أول خطوة عند تحميل الصفحة
              showStep(0);

              // معالجة إرسال الفورم
              form.addEventListener('submit', async (e) => {
                e.preventDefault();

                const data = {
                  company: {
                    name: companyName.value,
                    ownerName: ownerName.value,
                    phone: companyPhone.value,
                    plan: plan.value,
                    subscriptionType: subscriptionType.value
                  },
                  admin: {
                    fullName: adminName.value,
                    email: adminEmail.value,
                    phone: adminPhone.value,
                    password: adminPassword.value
                  }
                };

                try {
                  const res = await fetch('/super-admin/companies/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                  });
                  const result = await res.json();

                  if (res.ok) {
                    window.location.href = '/super-admin/companies';
                  } else {
                    alert(result.message || 'حدث خطأ');
                  }
                } catch (err) {
                  alert('خطأ في الاتصال بالخادم');
                }
              });
            </script>

  </body>

</html>
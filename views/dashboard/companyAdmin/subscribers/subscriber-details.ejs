<!doctype html>
<html lang="en" dir="rtl">
  <%- include('../../../partials/head.ejs') %>
  <body>
    <!-- loader Start -->
    <div id="loading">
      <div class="loader simple-loader">
        <div class="loader-body"></div>
      </div>
    </div>
    <!-- loader END -->

    <%- include('../../../partials/sidebar.ejs') %>

    <main class="main-content">
      <div class="position-relative iq-banner">
        <%- include('../../../partials/navbar.ejs') %>
      </div>

      <div class="container-fluid content-inner mt-n5 py-0">
        <div class="row">
          <div class="col-12">
            <!-- Header Section -->
            <div class="card mb-3">
              <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                  <h4 class="mb-1"><%= subscriber.fullName %></h4>
                  <p class="mb-0">رقم المشترك: <%= subscriber.subscriberNumber %> | رقم العداد: <%= subscriber.meterNumber %></p>
                  <p class="mb-0">المنطقة: <%= subscriber.area %></p>
                </div>
                <div>
                  <% if (subscriber.isActive) { %>
                    <span class="badge bg-success">نشط</span>
                  <% } else { %>
                    <span class="badge bg-danger">متوقف</span>
                  <% } %>
                </div>
              </div>
            </div>

            <!-- Summary Cards -->
            <div class="row mb-3">
              <div class="col-md-2 col-sm-6 mb-2">
                <div class="card text-center">
                  <div class="card-body">
                    <h6>آخر قراءة</h6>
                    <h5><%= subscriber.lastReading %></h5>
                  </div>
                </div>
              </div>
              <div class="col-md-2 col-sm-6 mb-2">
                <div class="card text-center">
                  <div class="card-body">
                    <h6>آخر فاتورة</h6>
                    <h5><%= subscriber.lastBill %> جنيه</h5>
                  </div>
                </div>
              </div>
              <div class="col-md-2 col-sm-6 mb-2">
                <div class="card text-center">
                  <div class="card-body">
                    <h6>الاستهلاك الحالي</h6>
                    <h5><%= subscriber.currentConsumption %> م³</h5>
                  </div>
                </div>
              </div>
              <div class="col-md-2 col-sm-6 mb-2">
                <div class="card text-center">
                  <div class="card-body">
                    <h6>إجمالي الديون</h6>
                    <h5><%= subscriber.totalDebt %> جنيه</h5>
                  </div>
                </div>
              </div>
              <div class="col-md-2 col-sm-6 mb-2">
                <div class="card text-center">
                  <div class="card-body">
                    <h6>عدد الفواتير غير المسددة</h6>
                    <h5><%= subscriber.unpaidBillsCount %></h5>
                  </div>
                </div>
              </div>
              <div class="col-md-2 col-sm-6 mb-2">
                <div class="card text-center">
                  <div class="card-body">
                    <h6>آخر دفع</h6>
                    <h5><%= subscriber.lastPaymentDate ? new Date(subscriber.lastPaymentDate).toLocaleDateString('ar-EG') : '-' %></h5>
                  </div>
                </div>
              </div>
            </div>

            <!-- Tabs Section -->
            <div class="card">
              <div class="card-body">
                <ul class="nav nav-tabs" id="subscriberTabs" role="tablist">
                  <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="personal-tab" data-bs-toggle="tab" data-bs-target="#personal" type="button" role="tab">البيانات الشخصية</button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button class="nav-link" id="readings-tab" data-bs-toggle="tab" data-bs-target="#readings" type="button" role="tab">سجل القراءات</button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button class="nav-link" id="bills-tab" data-bs-toggle="tab" data-bs-target="#bills" type="button" role="tab">الفواتير</button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button class="nav-link" id="payments-tab" data-bs-toggle="tab" data-bs-target="#payments" type="button" role="tab">المدفوعات</button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button class="nav-link" id="debts-tab" data-bs-toggle="tab" data-bs-target="#debts" type="button" role="tab">الديون السابقة</button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button class="nav-link" id="notes-tab" data-bs-toggle="tab" data-bs-target="#notes" type="button" role="tab">الملاحظات</button>
                  </li>
                </ul>

                <div class="tab-content mt-3">
                  <!-- Personal Data -->
                  <div class="tab-pane fade show active" id="personal" role="tabpanel">
                    <div class="row">
                      <div class="col-md-6 mb-2">
                        <strong>الاسم الكامل:</strong> <%= subscriber.fullName %>
                      </div>
                      <div class="col-md-6 mb-2">
                        <strong>رقم الهوية:</strong> <%= subscriber.idNumber %>
                      </div>
                      <div class="col-md-6 mb-2">
                        <strong>رقم الهاتف:</strong> <%= subscriber.phone %>
                      </div>
                      <div class="col-md-6 mb-2">
                        <strong>العنوان:</strong> <%= subscriber.address %>
                      </div>
                      <div class="col-md-6 mb-2">
                        <strong>نوع الاشتراك:</strong> <%= subscriber.subscriptionType %>
                      </div>
                      <div class="col-md-6 mb-2">
                        <strong>تاريخ الاشتراك:</strong> <%= new Date(subscriber.subscriptionDate).toLocaleDateString('ar-EG') %>
                      </div>
                      <div class="col-md-6 mb-2">
                        <strong>حالة العداد:</strong> <%= subscriber.meterStatus %>
                      </div>
                    </div>
                  </div>

                  <!-- Readings -->
                  <div class="tab-pane fade" id="readings" role="tabpanel">
                    <div class="table-responsive">
                      <table class="table table-striped table-hover">
                        <thead>
                          <tr>
                            <th>الشهر</th>
                            <th>القراءة السابقة</th>
                            <th>القراءة الحالية</th>
                            <th>الاستهلاك</th>
                            <th>تاريخ الإدخال</th>
                            <th>الموظف</th>
                          </tr>
                        </thead>
                        <tbody>
                          <% subscriber.readings.forEach(r => { %>
                            <tr>
                              <td><%= r.month %></td>
                              <td><%= r.previousReading %></td>
                              <td><%= r.currentReading %></td>
                              <td><%= r.consumption %></td>
                              <td><%= new Date(r.date).toLocaleDateString('ar-EG') %></td>
                              <td><%= r.employee %></td>
                            </tr>
                          <% }) %>
                        </tbody>
                      </table>
                    </div>
                  </div>

                  <!-- Bills -->
                  <div class="tab-pane fade" id="bills" role="tabpanel">
                    <div class="table-responsive">
                      <table class="table table-striped table-hover">
                        <thead>
                          <tr>
                            <th>رقم الفاتورة</th>
                            <th>الشهر</th>
                            <th>قيمة الاستهلاك</th>
                            <th>الرسوم</th>
                            <th>المجموع</th>
                            <th>الحالة</th>
                            <th>تاريخ الاستحقاق</th>
                          </tr>
                        </thead>
                        <tbody>
                          <% subscriber.bills.forEach(b => { %>
                            <tr>
                              <td><%= b.billNumber %></td>
                              <td><%= b.month %></td>
                              <td><%= b.consumptionFee %></td>
                              <td><%= b.additionalFees %></td>
                              <td><%= b.total %></td>
                              <td>
                                <% if (b.status === 'مدفوعة') { %>
                                  <span class="badge bg-success">مدفوعة</span>
                                <% } else { %>
                                  <span class="badge bg-danger">غير مدفوعة</span>
                                <% } %>
                              </td>
                              <td><%= new Date(b.dueDate).toLocaleDateString('ar-EG') %></td>
                            </tr>
                          <% }) %>
                        </tbody>
                      </table>
                    </div>
                  </div>

                  <!-- Payments -->
                  <div class="tab-pane fade" id="payments" role="tabpanel">
                    <div class="table-responsive">
                      <table class="table table-striped table-hover">
                        <thead>
                          <tr>
                            <th>تاريخ الدفع</th>
                            <th>المبلغ</th>
                            <th>طريقة الدفع</th>
                            <th>الفاتورة المرتبطة</th>
                            <th>الموظف</th>
                          </tr>
                        </thead>
                        <tbody>
                          <% subscriber.payments.forEach(p => { %>
                            <tr>
                              <td><%= new Date(p.date).toLocaleDateString('ar-EG') %></td>
                              <td><%= p.amount %></td>
                              <td><%= p.method %></td>
                              <td><%= p.billNumber %></td>
                              <td><%= p.employee %></td>
                            </tr>
                          <% }) %>
                        </tbody>
                      </table>
                    </div>
                  </div>

                  <!-- Debts -->
                  <div class="tab-pane fade" id="debts" role="tabpanel">
                    <div class="table-responsive">
                      <table class="table table-striped table-hover">
                        <thead>
                          <tr>
                            <th>المبلغ</th>
                            <th>السبب</th>
                            <th>تاريخ الترحيل</th>
                            <th>المتبقي</th>
                            <th>تم جدولته؟</th>
                          </tr>
                        </thead>
                        <tbody>
                          <% subscriber.debts.forEach(d => { %>
                            <tr>
                              <td><%= d.amount %></td>
                              <td><%= d.reason %></td>
                              <td><%= new Date(d.date).toLocaleDateString('ar-EG') %></td>
                              <td><%= d.remaining %></td>
                              <td><%= d.isScheduled ? 'نعم' : 'لا' %></td>
                            </tr>
                          <% }) %>
                        </tbody>
                      </table>
                    </div>
                  </div>

                  <!-- Notes -->
                  <div class="tab-pane fade" id="notes" role="tabpanel">
                    <ul class="list-group">
                      <% subscriber.notes.forEach(n => { %>
                        <li class="list-group-item">
                          <strong><%= n.date ? new Date(n.date).toLocaleDateString('ar-EG') : '-' %>:</strong> <%= n.note %>
                        </li>
                      <% }) %>
                    </ul>
                  </div>

                </div>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- Footer -->
      <%- include('../../../partials/footer.ejs') %>
    </main>

    <%- include('../../../partials/offcanvas.ejs') %>
    <%- include('../../../partials/scripts.ejs') %>
  </body>
</html>

<!doctype html>
<html lang="en" dir="rtl">
<%- include('../../../partials/head.ejs') %>

  <body>
    <!-- loader Start -->
    <div id="loading">
      <div class="loader simple-loader">
        <div class="loader-body"></div>
      </div>
    </div>
    <!-- loader END -->

    <%- include('../../../partials/sidebar.ejs') %>

      <main class="main-content">
        <div class="position-relative iq-banner">
          <%- include('../../../partials/navbar.ejs') %>
        </div>

        <div class="container-fluid content-inner mt-n5 py-0">
          <div class="row">
            <div class="col-12">
              <!-- Header Section -->
              <div class="card mb-3">
                <div class="card-body d-flex justify-content-between align-items-center">
                  <div>
                    <h4 class="mb-1">
                      <%= subscriber.fullName %>
                    </h4>
                    <p class="mb-0">رقم الهاتف: <%= subscriber.phone %> | رقم العداد: <%= subscriber.meterId ?
                          subscriber.meterId.serialNumber : 'بدون عداد' %>
                    </p>
                    <p class="mb-0">المنطقة: <%= subscriber.primaryArea ? subscriber.primaryArea.name : '' %>
                        <%= subscriber.secondaryArea ? '- ' + subscriber.secondaryArea.name : '' %>
                    </p>
                  </div>
                  <div>
                    <% if (subscriber.isActive) { %>
                      <span class="badge bg-success">نشط</span>
                      <% } else { %>
                        <span class="badge bg-danger">متوقف</span>
                        <% } %>
                  </div>
                </div>
              </div>

              <!-- Summary Cards -->
              <div class="row mb-3">
                <div class="col-md-2 col-sm-6 mb-2">
                  <div class="card text-center">
                    <div class="card-body">
                      <h6>آخر قراءة</h6>
                      <h5>
                        <%= lastReading ? lastReading.readingValue : 0 %>
                      </h5>
                    </div>
                  </div>
                </div>
                <div class="col-md-2 col-sm-6 mb-2">
                  <div class="card text-center">
                    <div class="card-body">
                      <h6>آخر فاتورة</h6>
                      <h5>
                        <%= lastInvoice ? lastInvoice.totalAmount : 0 %> شيكل
                      </h5>
                    </div>
                  </div>
                </div>
                <div class="col-md-2 col-sm-6 mb-2">
                  <div class="card text-center">
                    <div class="card-body">
                      <h6>الاستهلاك الأخير</h6>
                      <h5>
                        <%= lastReading ? lastReading.consumption : 0 %> KW
                      </h5>
                    </div>
                  </div>
                </div>
                <div class="col-md-2 col-sm-6 mb-2">
                  <div class="card text-center">
                    <div class="card-body">
                      <h6>إجمالي الديون</h6>
                      <h5>
                        <%= financialSummary.totalRemaining.toFixed(2) %> شيكل
                      </h5>
                    </div>
                  </div>
                </div>
                <div class="col-md-2 col-sm-6 mb-2">
                  <div class="card text-center">
                    <div class="card-body">
                      <h6>فواتير غير مسددة</h6>
                      <h5>
                        <%= financialSummary.unpaidBillsCount %>
                      </h5>
                    </div>
                  </div>
                </div>
                <div class="col-md-2 col-sm-6 mb-2">
                  <div class="card text-center">
                    <div class="card-body">
                      <h6>آخر دفع</h6>
                      <h5>
                        <%= transactions.length> 0 ? new Date(transactions[0].createdAt).toLocaleDateString('ar-EG') :
                          '-' %>
                      </h5>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Tabs Section -->
              <div class="card">
                <div class="card-body">
                  <ul class="nav nav-tabs" id="subscriberTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                      <button class="nav-link active" id="personal-tab" data-bs-toggle="tab" data-bs-target="#personal"
                        type="button" role="tab">البيانات الشخصية</button>
                    </li>
                    <li class="nav-item" role="presentation">
                      <button class="nav-link" id="readings-tab" data-bs-toggle="tab" data-bs-target="#readings"
                        type="button" role="tab">سجل القراءات</button>
                    </li>
                    <li class="nav-item" role="presentation">
                      <button class="nav-link" id="bills-tab" data-bs-toggle="tab" data-bs-target="#bills" type="button"
                        role="tab">الفواتير</button>
                    </li>
                    <li class="nav-item" role="presentation">
                      <button class="nav-link" id="payments-tab" data-bs-toggle="tab" data-bs-target="#payments"
                        type="button" role="tab">المدفوعات</button>
                    </li>
                  </ul>

                  <div class="tab-content mt-3">
                    <!-- Personal Data -->
                    <div class="tab-pane fade show active" id="personal" role="tabpanel">
                      <div class="row">
                        <div class="col-md-6 mb-2">
                          <strong>الاسم الكامل:</strong>
                          <%= subscriber.fullName %>
                        </div>
                        <div class="col-md-6 mb-2">
                          <strong>رقم الهوية:</strong>
                          <%= subscriber.nationalId || '-' %>
                        </div>
                        <div class="col-md-6 mb-2">
                          <strong>رقم الهاتف:</strong>
                          <%= subscriber.phone %>
                        </div>
                        <div class="col-md-6 mb-2">
                          <strong>العنوان:</strong>
                          <%= subscriber.address || '-' %>
                        </div>
                        <div class="col-md-6 mb-2">
                          <strong>نوع الاشتراك:</strong>
                          <%= subscriber.type==='HOME' ? 'منزلي' : 'تجاري' %>
                        </div>
                        <div class="col-md-6 mb-2">
                          <strong>القرائة الأولية للعداد:</strong>
                          <%= subscriber.meterId ? subscriber.meterId.initialReading : '-' %>
                        </div>
                        <div class="col-md-6 mb-2">
                          <strong>المحصل المسؤول:</strong>
                          <%= subscriber.assignedCollector ? subscriber.assignedCollector.fullName : '-' %>
                        </div>
                        <div class="col-md-6 mb-2">
                          <strong>تاريخ الإضافة:</strong>
                          <%= new Date(subscriber.createdAt).toLocaleDateString('ar-EG') %>
                        </div>
                      </div>
                    </div>

                    <!-- Readings -->
                    <div class="tab-pane fade" id="readings" role="tabpanel">
                      <div class="table-responsive">
                        <table class="table table-striped table-hover">
                          <thead>
                            <tr>
                              <th>التاريخ</th>
                              <th>القراءة السابقة</th>
                              <th>القراءة الحالية</th>
                              <th>الاستهلاك (KW)</th>
                              <th>المحصل</th>
                              <th>الحالة</th>
                            </tr>
                          </thead>
                          <tbody>
                            <% readings.forEach(r=> { %>
                              <tr>
                                <td>
                                  <%= new Date(r.readingDate).toLocaleDateString('ar-EG') %>
                                </td>
                                <td>
                                  <%= r.previousReading %>
                                </td>
                                <td>
                                  <%= r.readingValue %>
                                </td>
                                <td>
                                  <%= r.consumption %>
                                </td>
                                <td>
                                  <%= r.collector ? r.collector.fullName : 'نظام' %>
                                </td>
                                <td>
                                  <span class="badge <%= r.status === 'INVOICED' ? 'bg-success' : 'bg-warning' %>">
                                    <%= r.status==='INVOICED' ? 'مفوترة' : 'جديدة' %>
                                  </span>
                                </td>
                              </tr>
                              <% }) %>
                          </tbody>
                        </table>
                      </div>
                    </div>

                    <!-- Bills -->
                    <div class="tab-pane fade" id="bills" role="tabpanel">
                      <div class="table-responsive">
                        <table class="table table-striped table-hover">
                          <thead>
                            <tr>
                              <th>رقم الفاتورة</th>
                              <th>تاريخ الإصدار</th>
                              <th>الاستهلاك</th>
                              <th>أخرى/ديون</th>
                              <th>المجموع</th>
                              <th>المدفوع</th>
                              <th>المتبقي</th>
                              <th>الحالة</th>
                            </tr>
                          </thead>
                          <tbody>
                            <% invoices.forEach(b=> { %>
                              <tr>
                                <td>
                                  <%= b.invoiceNumber %>
                                </td>
                                <td>
                                  <%= new Date(b.issueDate).toLocaleDateString('ar-EG') %>
                                </td>
                                <td>
                                  <%= (b.consumption * b.unitPrice).toFixed(2) %>
                                </td>
                                <td>
                                  <%= (b.fixedFees + b.taxes + b.arrears).toFixed(2) %>
                                </td>
                                <td><strong>
                                    <%= b.totalAmount.toFixed(2) %>
                                  </strong></td>
                                <td class="text-success">
                                  <%= b.paidAmount.toFixed(2) %>
                                </td>
                                <td class="text-danger">
                                  <%= b.remainingAmount.toFixed(2) %>
                                </td>
                                <td>
                                  <% if (b.status==='PAID' ) { %>
                                    <span class="badge bg-success">مدفوعة</span>
                                    <% } else if (b.status==='PARTIAL' ) { %>
                                      <span class="badge bg-info">دفع جزئي</span>
                                      <% } else { %>
                                        <span class="badge bg-danger">غير مدفوعة</span>
                                        <% } %>
                                </td>
                              </tr>
                              <% }) %>
                          </tbody>
                        </table>
                      </div>
                    </div>

                    <!-- Payments -->
                    <div class="tab-pane fade" id="payments" role="tabpanel">
                      <div class="table-responsive">
                        <table class="table table-striped table-hover">
                          <thead>
                            <tr>
                              <th>تاريخ الدفع</th>
                              <th>المبلغ</th>
                              <th>رقم الفاتورة</th>
                              <th>المحصل</th>
                              <th>ملاحظات</th>
                            </tr>
                          </thead>
                          <tbody>
                            <% transactions.forEach(p=> { %>
                              <tr>
                                <td>
                                  <%= new Date(p.createdAt).toLocaleDateString('ar-EG') %>
                                </td>
                                <td class="text-success"><strong>
                                    <%= p.amount.toFixed(2) %> شيكل
                                  </strong></td>
                                <td>
                                  <%= p.metadata ? p.metadata.invoiceNumber : '-' %>
                                </td>
                                <td>
                                  <%= p.performedBy ? p.performedBy.fullName : '-' %>
                                </td>
                                <td>
                                  <%= p.description %>
                                </td>
                              </tr>
                              <% }) %>
                          </tbody>
                        </table>
                      </div>
                    </div>

                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>

        </div>
        </div>
        </div>

        <!-- Footer -->
        <%- include('../../../partials/footer.ejs') %>
      </main>

      <%- include('../../../partials/offcanvas.ejs') %>
        <%- include('../../../partials/scripts.ejs') %>
  </body>

</html>
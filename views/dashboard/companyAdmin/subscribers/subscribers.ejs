<!doctype html>
<html lang="en" dir="rtl">
<%- include('../../../partials/head.ejs') %>

  <body>
    <div id="loading">
      <div class="loader simple-loader">
        <div class="loader-body"></div>
      </div>
    </div>

    <%- include('../../../partials/sidebar.ejs') %>

      <main class="main-content">
        <div class="position-relative iq-banner">
          <%- include('../../../partials/navbar.ejs') %>
        </div>

        <div class="container-fluid content-inner mt-n5 py-0">
          <div class="row">
            <div class="col-12">
              <div class="card">

                <!-- HEADER -->
                <div class="card-header d-flex justify-content-between align-items-center">
                  <h4 class="card-title mb-0">قائمة المشتركين</h4>
                  <a href="/company-admin/subscribers/create" class="btn btn-primary btn-sm">
                    إضافة مشترك
                  </a>
                </div>

                <!-- FILTERS -->
                <div class="card-body border-bottom">
                  <div class="row g-2">

                    <div class="col-md-3">
                      <input type="text" id="searchInput" class="form-control" placeholder="بحث بالاسم أو رقم الجوال">
                    </div>

                    <div class="col-md-2">
                      <select id="statusFilter" class="form-select">
                        <option value="">الحالة</option>
                        <option value="true">مفعل</option>
                        <option value="false">غير مفعل</option>
                      </select>
                    </div>

                    <div class="col-md-2">
                      <select id="typeFilter" class="form-select">
                        <option value="">نوع الاشتراك</option>
                        <option value="HOME">منزلي</option>
                        <option value="COMMERCIAL">تجاري</option>
                      </select>
                    </div>

                    <div class="col-md-2">
                      <select id="primaryAreaFilter" class="form-select">
                        <option value="">المنطقة الرئيسية</option>
                        <% primaryAreas.forEach(a=> { %>
                          <option value="<%= a._id %>">
                            <%= a.name %>
                          </option>
                          <% }) %>
                      </select>
                    </div>

                    <div class="col-md-2">
                      <select id="secondaryAreaFilter" class="form-select">
                        <option value="">المنطقة الفرعية</option>
                      </select>
                    </div>

                  </div>
                </div>

                <!-- TABLE -->
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-striped table-hover">
                      <thead>
                        <tr>
                          <th>الاسم</th>
                          <th>رقم الهاتف</th>
                          <th>المنطقة</th>
                          <th>المحصل</th>
                          <th>نوع الاشتراك</th>
                          <th>الحالة</th>
                          <th>إجراءات</th>
                        </tr>
                      </thead>
                      <tbody id="subscribersTable">

                        <% subscribers.forEach(s=> { %>
                          <tr data-name="<%= s.fullName %>" data-phone="<%= s.phone %>" data-status="<%= s.isActive %>"
                            data-type="<%= s.type %>" data-primary="<%= s.primaryArea?._id %>"
                            data-secondary="<%= s.secondaryArea?._id || '' %>">
                            <td>
                              <%= s.fullName %>
                            </td>
                            <td>
                              <%= s.phone %>
                            </td>
                            <td>
                              <%= s.primaryArea?.name %>
                                <% if (s.secondaryArea) { %>
                                  - <%= s.secondaryArea.name %>
                                    <% } %>
                            </td>
                            <td>
                              <%= s.assignedCollector ? s.assignedCollector.fullName : '-' %>
                            </td>
                            <td>
                              <span class="badge bg-info">
                                <%= s.type==='HOME' ? 'منزلي' : 'تجاري' %>
                              </span>
                            </td>
                            <td>
                              <% if (s.isActive) { %>
                                <span class="badge bg-success">مفعل</span>
                                <% } else { %>
                                  <span class="badge bg-danger">غير مفعل</span>
                                  <% } %>
                            </td>
                            <td>
                              <a href="/company-admin/subscribers/<%= s._id %>" class="btn btn-info btn-sm">عرض</a>
                            </td>
                          </tr>
                          <% }) %>

                      </tbody>
                    </table>
                  </div>
                </div>

              </div>
            </div>
          </div>
        </div>

        <%- include('../../../partials/footer.ejs') %>
      </main>

      <%- include('../../../partials/scripts.ejs') %>

        <!-- FILTER LOGIC -->
        <script>
          const rows = document.querySelectorAll('#subscribersTable tr');

          const searchInput = document.getElementById('searchInput');
          const statusFilter = document.getElementById('statusFilter');
          const typeFilter = document.getElementById('typeFilter');
          const primaryFilter = document.getElementById('primaryAreaFilter');
          const secondaryFilter = document.getElementById('secondaryAreaFilter');

          // دالة تطبيق الفلاتر على الصفوف
          function applyFilters() {
            rows.forEach(row => {
              const name = row.dataset.name.toLowerCase();
              const phone = row.dataset.phone;
              const status = row.dataset.status;
              const type = row.dataset.type;
              const primary = row.dataset.primary;
              const secondary = row.dataset.secondary;

              const searchOk =
                name.includes(searchInput.value.toLowerCase()) ||
                phone.includes(searchInput.value);

              const statusOk = !statusFilter.value || status === statusFilter.value;
              const typeOk = !typeFilter.value || type === typeFilter.value;
              const primaryOk = !primaryFilter.value || primary === primaryFilter.value;
              const secondaryOk = !secondaryFilter.value || secondary === secondaryFilter.value;

              row.style.display =
                searchOk && statusOk && typeOk && primaryOk && secondaryOk
                  ? ''
                  : 'none';
            });
          }

          // Event listeners للفلاتر
          searchInput.addEventListener('input', applyFilters);
          [statusFilter, typeFilter, primaryFilter, secondaryFilter].forEach(el =>
            el.addEventListener('change', applyFilters)
          );

          // جلب المناطق الفرعية عند اختيار المنطقة الرئيسية
          primaryFilter.addEventListener('change', async () => {
            const primaryAreaId = primaryFilter.value;

            // تفريغ فلتر المناطق الفرعية
            secondaryFilter.innerHTML = '<option value="">المنطقة الفرعية</option>';

            if (!primaryAreaId) {
              applyFilters();
              return;
            }

            try {
              const res = await fetch(`/company-admin/areas/${primaryAreaId}/sub-areas`);
              const subAreas = await res.json();

              subAreas.forEach(area => {
                const option = document.createElement('option');
                option.value = area._id;
                option.textContent = area.name;
                secondaryFilter.appendChild(option);
              });
            } catch (err) {
              console.error('Failed to load sub areas', err);
            }

            applyFilters();
          });
        </script>

  </body>

</html>
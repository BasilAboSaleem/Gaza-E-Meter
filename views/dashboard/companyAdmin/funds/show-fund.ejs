<!doctype html>
<html lang="ar" dir="rtl">
  <%- include('../../../partials/head.ejs') %>
  <body>

    <!-- loader -->
    <div id="loading">
      <div class="loader simple-loader">
        <div class="loader-body"></div>
      </div>
    </div>

    <%- include('../../../partials/sidebar.ejs') %>

    <main class="main-content">
      <div class="position-relative iq-banner">
        <%- include('../../../partials/navbar.ejs') %>
      </div>

      <div class="container-fluid content-inner mt-n5 py-0">
        <div class="row">
          <div class="col-12">

            <% if (fund) { %>

              <!-- ๐ฆ ุจุทุงูุฉ ุชูุงุตูู ุงูุตูุฏูู -->
              <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <h4 class="card-title mb-0"><%= fund.name %></h4>

                  <%
                    const FUND_TYPE_LABELS = {
                      COMPANY: 'ุตูุฏูู ุงูุดุฑูุฉ',
                      COLLECTOR: 'ุตูุฏูู ูุญุตูู',
                      BANK: 'ุจูู',
                      EXPENSES: 'ูุตุฑููุงุช',
                      OTHER: 'ุฃุฎุฑู'
                    };
                  %>

                  <span class="badge bg-info">
                    <%= FUND_TYPE_LABELS[fund.type] || fund.type %>
                  </span>
                </div>

                <div class="card-body">
                  <div class="row">

                    <div class="col-md-4 mb-2">
                      <strong>ุงูุฑุตูุฏ ุงูุญุงูู:</strong><br>
                      <span class="fw-bold text-success fs-5">
                        <%= fund.balance %> <%= fund.currency %>
                      </span>
                    </div>

                    <div class="col-md-4 mb-2">
                      <strong>ุงูุญุงูุฉ:</strong><br>
                      <% if (fund.isActive) { %>
                        <span class="badge bg-success">ููุนูู</span>
                      <% } else { %>
                        <span class="badge bg-danger">ุบูุฑ ููุนูู</span>
                      <% } %>
                    </div>

                    <div class="col-md-4 mb-2">
                      <strong>ุชุงุฑูุฎ ุงูุฅูุดุงุก:</strong><br>
                      <%= new Date(fund.createdAt).toLocaleDateString('ar-EG') %>
                    </div>

                    <div class="col-12 mt-3">
                      <strong>ููุงุญุธุงุช:</strong>
                      <p class="mb-0 text-muted">
                        <%= fund.notes || 'ูุง ุชูุฌุฏ ููุงุญุธุงุช' %>
                      </p>
                    </div>

                  </div>
                </div>
              </div>

              <!-- ๐ฉ ุฌุฏูู ุงูุญุฑูุงุช ุงููุงููุฉ -->
              <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <h4 class="card-title mb-0">ุงูุญุฑูุงุช ุงููุงููุฉ</h4>

                  <a href="/company-admin/transactions/create"
                     class="btn btn-primary btn-sm">
                    โ ุฅุถุงูุฉ ุญุฑูุฉ
                  </a>
                </div>

                <div class="card-body">

                  <!-- Filters -->
                  <div class="row mb-3">
                    <div class="col-md-4 mb-2">
                      <select id="typeFilter" class="form-select">
                        <option value="">ูู ุงูุฃููุงุน</option>
                        <option value="COLLECTION">ูุจุถ</option>
                        <option value="EXPENSE">ุตุฑู</option>
                        <option value="TRANSFER">ุชุญููู</option>
                        <option value="ADJUSTMENT">ุฑุตูุฏ ุงูุชุชุงุญู / ุชุนุฏูู</option>
                      </select>
                    </div>

                    <div class="col-md-4 mb-2">
                      <select id="directionFilter" class="form-select">
                        <option value="">ูุงุฑุฏ + ุตุงุฏุฑ</option>
                        <option value="IN">ูุงุฑุฏ</option>
                        <option value="OUT">ุตุงุฏุฑ</option>
                      </select>
                    </div>
                  </div>

                  <% if (transactions && transactions.length > 0) { %>
                    <% let runningBalance = 0; %>

                    <div class="table-responsive">
                      <table class="table table-striped table-hover align-middle">
                        <thead class="table-light">
                          <tr>
                            <th>ุงูุชุงุฑูุฎ</th>
                            <th>ุงูููุน</th>
                            <th>ุงูุงุชุฌุงู</th>
                            <th>ุงููุจูุบ</th>
                            <th>ุงูุฑุตูุฏ ุงูุชุฑุงููู</th>
                            <th>ุงููุตู</th>
                            <th>ุจูุงุณุทุฉ</th>
                          </tr>
                        </thead>
                        <tbody>
                          <% transactions.forEach(tx => { %>

                            <% 
                              if (tx.direction === 'IN') {
                                runningBalance += tx.amount;
                              } else {
                                runningBalance -= tx.amount;
                              }
                            %>

                            <tr
                              class="tx-row"
                              data-type="<%= tx.type %>"
                              data-direction="<%= tx.direction %>"
                              data-description="<%= tx.description.toLowerCase() %>"
                            >
                              <td>
                                <%= new Date(tx.createdAt).toLocaleDateString('ar-EG') %>
                              </td>

                              <td>
                                <% if (tx.type === 'COLLECTION') { %>
                                  ูุจุถ
                                <% } else if (tx.type === 'EXPENSE') { %>
                                  ุตุฑู
                                <% } else if (tx.type === 'TRANSFER') { %>
                                  ุชุญููู
                                <% } else { %>
                                  ุฑุตูุฏ ุงูุชุชุงุญู / ุชุนุฏูู
                                <% } %>
                              </td>

                              <td>
                                <% if (tx.direction === 'IN') { %>
                                  <span class="badge bg-success">ูุงุฑุฏ</span>
                                <% } else { %>
                                  <span class="badge bg-danger">ุตุงุฏุฑ</span>
                                <% } %>
                              </td>

                              <td class="<%= tx.direction === 'IN' ? 'text-success' : 'text-danger' %> fw-bold">
                                <%= tx.amount.toLocaleString('ar-EG') %> <%= fund.currency %>
                              </td>

                              <td>
                                <span class="<%= runningBalance >= 0 ? 'text-success' : 'text-danger' %> fw-bold">
                                  <%= runningBalance.toLocaleString('ar-EG') %>
                                </span> <%= fund.currency %>
                              </td>

                              <td>
                                <%= tx.description %>
                              </td>

                              <td>
                                <%= tx.performedBy?.fullName || 'โ' %>
                              </td>
                            </tr>
                          <% }) %>
                        </tbody>
                      </table>
                    </div>
                  <% } else { %>
                    <p class="text-muted mb-0">ูุง ุชูุฌุฏ ุญุฑูุงุช ูุงููุฉ ููุฐุง ุงูุตูุฏูู.</p>
                  <% } %>
                </div>
              </div>

            <% } else { %>
              <div class="alert alert-danger">
                ุงูุตูุฏูู ุบูุฑ ููุฌูุฏ
              </div>
            <% } %>

          </div>
        </div>
      </div>

      <%- include('../../../partials/footer.ejs') %>
    </main>

    <%- include('../../../partials/offcanvas.ejs') %>
    <%- include('../../../partials/scripts.ejs') %>

    <!-- Filters Script -->
    <script>
      const typeFilter = document.getElementById('typeFilter');
      const directionFilter = document.getElementById('directionFilter');
      const rows = document.querySelectorAll('.tx-row');

      function filterTransactions() {
        const type = typeFilter.value;
        const direction = directionFilter.value;

        rows.forEach(row => {
          const matchType = !type || row.dataset.type === type;
          const matchDirection = !direction || row.dataset.direction === direction;

          row.style.display = matchType && matchDirection ? '' : 'none';
        });
      }

      typeFilter.addEventListener('change', filterTransactions);
      directionFilter.addEventListener('change', filterTransactions);
    </script>

  </body>
</html>

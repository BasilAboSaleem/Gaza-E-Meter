<%- include('../../partials/head.ejs') %>

  <body dir="rtl">
    <%- include('../../partials/sidebar.ejs') %>
      <main class="main-content">
        <div class="position-relative iq-banner">
          <%- include('../../partials/navbar.ejs') %>
        </div>
        <div class="container-fluid content-inner mt-n5 py-0">
          <div class="row">
            <div class="col-12">
              <div class="card shadow-sm border-0">
                <div class="card-header border-bottom d-flex justify-content-between align-items-center py-3">
                  <div class="header-title">
                    <h4 class="card-title mb-0 text-primary">
                      <i class="bi bi-arrow-repeat me-2"></i>مزامنة البيانات
                    </h4>
                    <p class="mb-0 text-muted small" id="sync-status">جارٍ التحقق من القراءات المحلية...</p>
                  </div>
                  <button id="btn-sync" class="btn btn-primary px-4 shadow-sm">
                    <i class="bi bi-cloud-upload me-1"></i> مزامنة الآن
                  </button>
                </div>
                <div class="card-body p-0">
                  <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0" id="readings-table">
                      <thead class="bg-light text-dark fw-bold">
                        <tr>
                          <th>المشترك</th>
                          <th>رقم العداد</th>
                          <th>القراءة المسجلة</th>
                          <th>التاريخ</th>
                          <th class="text-center">الحالة</th>
                        </tr>
                      </thead>
                      <tbody></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        </div>

        <%- include('../../partials/footer.ejs') %>
      </main>

      <%- include('../../partials/scripts.ejs') %>
        <script src="https://unpkg.com/dexie@3/dist/dexie.js"></script>
        <script src="/assets/js/db.js"></script>
        <script>
          async function renderUnsyncedReadings() {
            const readings = await collectorDB.db.readings.where('isSynced').equals(0).toArray();

            const tbody = document.querySelector('#readings-table tbody');
            tbody.innerHTML = '';

            if (readings.length === 0) {
              tbody.innerHTML = '<tr><td colspan="5" class="text-center py-5 text-muted"><i class="bi bi-check-all h1 d-block mb-3"></i> جميع البيانات متزامنة حالياً</td></tr>';
              document.getElementById('sync-status').innerText = `لا توجد قراءات بانتظار المزامنة`;
              document.getElementById('btn-sync').disabled = true;
              return;
            }

            const subs = await collectorDB.db.subscribers.toArray();
            const subMap = {};
            const meterMap = {};
            subs.forEach(s => {
              subMap[s.id] = s.fullName;
              meterMap[s.id] = s.meterSerialNumber || s.meterId; // Use serial number if available
            });

            readings.forEach(r => {
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td class="align-middle fw-bold">${subMap[r.subscriberId] || 'غير معروف'}</td>
                <td class="align-middle"><code>${meterMap[r.subscriberId] || '-'}</code></td>
                <td class="align-middle text-primary fw-bold">${r.readingValue}</td>
                <td class="align-middle text-muted">${new Date(r.readingDate).toLocaleString('ar-EG')}</td>
                <td class="align-middle text-center">
                  <span class="badge bg-soft-warning text-warning">بانتظار المزامنة</span>
                </td>
              `;
              tbody.appendChild(tr);
            });

            document.getElementById('sync-status').innerText = `يوجد ${readings.length} قراءات بانتظار المزامنة`;
            document.getElementById('btn-sync').disabled = false;
          }

          document.getElementById('btn-sync').addEventListener('click', async () => {
            if (!navigator.onLine) {
              return Swal.fire('تنبيه', 'لا يوجد اتصال بالإنترنت حالياً', 'warning');
            }

            const btn = document.getElementById('btn-sync');
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> جارٍ المزامنة...';
            btn.disabled = true;

            try {
              const res = await collectorDB.syncAllUnsynced();

              if (res.status === 'success') {
                Swal.fire({
                  icon: 'success',
                  title: 'تمت المزامنة!',
                  text: `تم رفع ${res.result.success} قراءات بنجاح. ${res.result.duplicates ? `(تخطي ${res.result.duplicates} مكررة)` : ''}`,
                  confirmButtonText: 'إغلاق',
                  customClass: { confirmButton: 'btn btn-primary' }
                });
                renderUnsyncedReadings();
              } else if (res.status === 'empty') {
                Swal.fire('تنبيه', 'لا توجد قراءات بحاجة للمزامنة', 'info');
              } else {
                throw new Error(res.error || 'Server Error');
              }
            } catch (error) {
              console.error(error);
              Swal.fire('خطأ في المزامنة', error.message, 'error');
            } finally {
              btn.innerHTML = originalHtml;
              btn.disabled = false;
            }
          });

          // Listen for auto-sync events to refresh the table
          window.addEventListener('online', () => {
            setTimeout(renderUnsyncedReadings, 2000); // Wait for sync to complete
          });

          renderUnsyncedReadings();
        </script>
  </body>